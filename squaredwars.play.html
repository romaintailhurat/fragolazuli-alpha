<!DOCTYPE html>
<html>
<head>

 <link rel="stylesheet" type="text/css" href="/style/squaredwars.css">
 <!-- LIBS -->
 <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script>
 <script type="text/javascript" src="/_ah/channel/jsapi"></script>
 <script type="text/javascript" src="/javascript/lib/underscore-min.js"></script>
 <script type="text/javascript" src="/javascript/lib/backbone-min.js"></script>
 <!-- MAIN -->
 <script type="text/javascript" src="/javascript/squaredwars.js"></script>
 <script type="text/javascript">

    //----------------- channel handling
    function onOpened() {
      console.log('channel opened with token : {{token}}');
    };

    function onMessage(m) {
      console.log('onmessage : ' + m.data);
      var previous = $('#res').html();
      $('#res').html(previous + 'Message reçu : ' + m.data);
    };

    function onError(e) {
      console.log('onerror : ' + e);
    };

    function onClose(m) {
      console.log('onclose : ' + m);
    }

    //--------------- Send function

    function send(message) {
      console.log('sending message as JSON');
      var xhr = new XMLHttpRequest(),
        jsonMessage = {'message' : message};
      xhr.open('POST', '/squaredwars?m=' + JSON.stringify(jsonMessage), true);
      xhr.send();
    };
    
  $(document).ready(function(){

    //-------- Connection
    //le token est celui créé pour le client côté serveur
    channel = new goog.appengine.Channel('{{token}}');
    socket = channel.open();
    socket.onopen = onOpened;
    socket.onmessage = onMessage;
    socket.onerror = onError;
    socket.onclose = onClose;

    //-------- Instanciation models
    var gridModel = new GridModel({
      'grid': {{grid}}
      });

    console.log(gridModel.grid);

    //-------- Intanciation view
    var gridView = new GridView({
      'model' : gridModel,
      'el' : '#grid-area'
    });

    gridView.render();

    //TEST
    //displayGrid({{grid}});
   });

    
 </script>

</head>
<body>
 <h1>S Q U A R E D W A R S</h1>

 <div id="message-area">
  <p id="res"></p>
  <input id="message" type="textarea"/>
  <button id="trigger">send a message!</button>
 </div>

 <div>{{message}}</div>
 
 <div id="grid-area">
  
 </div>
 
</body>
</html>