<!DOCTYPE html>
<html>
<head>

 <link rel="stylesheet" type="text/css" href="/style/squaredwars.css">

 <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script>
 <script type="text/javascript" src="/_ah/channel/jsapi"></script>
 <script type="text/javascript" src="/javascript/squaredwars.js"></script>
 <script type="text/javascript">

    //----------------- channel handling
    function onOpened() {
      console.log('channel opened with token : {{token}}');
    };

    function onMessage(m) {
      console.log('onmessage : ' + m.data);
      var previous = $('#res').html();
      $('#res').html(previous + 'Message reçu : ' + m.data);
    };

    function onError(e) {
      console.log('onerror : ' + e);
    };

    function onClose(m) {
      console.log('onclose : ' + m);
    }

    //--------------- Send function

    function send(message) {
      console.log('sending message as JSON');
      var xhr = new XMLHttpRequest(),
        jsonMessage = {'message' : message};
      xhr.open('POST', '/squaredwars?m=' + JSON.stringify(jsonMessage), true);
      xhr.send();
    };

    
  $(document).ready(function(){

    //-------- Connection
    //le token est celui créé pour le client côté serveur
    channel = new goog.appengine.Channel('{{token}}');
    socket = channel.open();
    socket.onopen = onOpened;
    socket.onmessage = onMessage;
    socket.onerror = onError;
    socket.onclose = onClose;

    //-------- Grid creation
    
    $('#grid-generation').bind('click', function() {
      var g = generateGrid(10,5);
      displayGrid(g);  
    });

    //-------- Sending message

    $('#trigger').bind('click', function() {
      var messageToSend = $('#message').val();
      send(messageToSend);
    })

    //-------- POST : new game

    $('#create-game').bind('click', function() {
      debug('ask for a new game using POST request');
      //Trouble with relative path !!! that behave differently in dev and prod
      var DEV_URL = 'create',
          PROD_URL = 'squaredwars/create';

      $.post(DEV_URL, function(data) {
        debug(data);
        var link = "play?game_id=" + $.parseJSON(data).gameId;
        $('#creation-message').text("Link to your game : " + link);
      });
    });

  });

    
 </script>

</head>
<body>
 <h1>S Q U A R E D W A R S</h1>

 <div id="message-area">
  <p id="res"></p>
  <input id="message" type="textarea"/>
  <button id="trigger">send a message!</button>
 </div>
 
 <div id="grid-area">
  <button id="grid-generation">grid-generation</button>
  <button id="create-game">new game</button>
  <p id="creation-message"></p>
 </div>
 
</body>
</html>