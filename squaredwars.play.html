<!DOCTYPE html>
<html>
<head>
 <link rel="stylesheet" type="text/css" href="/bootstrap/css/bootstrap.min.css">
 <link rel="stylesheet" type="text/css" href="/style/squaredwars.css">
 
 <!-- LIBS -->
 <script type="text/javascript" src="/javascript/lib/jquery-1.8.2.min.js"></script>
 <script type="text/javascript" src="/_ah/channel/jsapi"></script>
 <script type="text/javascript" src="/javascript/lib/underscore-min.js"></script>
 <script type="text/javascript" src="/javascript/lib/backbone-min.js"></script>
 <script type="text/javascript" src="/javascript/lib/handlebars-1.0.rc.1.js"></script>
 <script type="text/javascript" src="/javascript/lib/easeljs-0.5.0.min.js"></script>

 <!-- MAIN -->
 <script type="text/javascript" src="/javascript/squaredwars.js"></script>
 <script type="text/javascript">

    //----------------- channel handling
    function onOpened() {
      console.log('channel opened with token : {{token}}');
    };

    function onMessage(m) {
      console.log('onmessage : ' + m.data);
      $('#message-area').html('Message reçu : ' + m.data);
    };

    function onError(e) {
      console.log('onerror : ' + e);
    };

    function onClose(m) {
      console.log('onclose : ' + m);
    }

    //--------------- Send function

    function send(sender, action) {
      console.log(sender + 'is sending a message to the other player');
      var xhr = new XMLHttpRequest();
      xhr.open('POST', '/squaredwars/play?player='+ sender + '&action=' + action, true);
      xhr.send();
    };

  $(document).ready(function(){

    //-------- START ??
    GAME.start();

    // current player is
    var currentPlayer = $('#player-name').text().trim();

    //-------- Connection
    //le token est celui créé pour le client côté serveur
    channel = new goog.appengine.Channel('{{token}}');
    socket = channel.open();
    socket.onopen = onOpened;
    socket.onmessage = onMessage;
    socket.onerror = onError;
    socket.onclose = onClose;

    //-------- Instanciation models

    GAME.gridModel = new GridModel({
      'grid': {{grid}}
    });

    GAME.resourceStackModel = new ResourceStackModel();

    //-------- Intanciation views

    GAME.gridView = new GridView({
      'model' : GAME.gridModel,
      'id' : 'grid-area'
    });

    GAME.gridView.render();

    GAME.resourceStackView = new ResourceStackView({
      model : GAME.resourceStackModel
    });

    GAME.resourceStackView.render();

    GAME.sondesView =  new SondesView();

    //-------- Instanciation collections

    GAME.sondes = new SondesCollection();
    //We're adding a sonde
    GAME.sondes.on('add remove', function() {
      var numberOfSondes= this.length;
      debug('adding a sonde to collection trigger the rendering of the sonde view');
      GAME.sondesView.render(numberOfSondes);
    });

    GAME.domes = new DomesCollection();

    // adding the starting dome for each player
    GAME.domes.add(new DomeModel()); 

    //-------- EVENTING

    //when the model change, the view is updated
    GAME.resourceStackModel.on('change', function() {
      GAME.resourceStackView.render();
    });

    //-------- TESTS

    $('#sonde-creation').bind('click',function(){
      //sondeM.trigger('sonde:create');
      if (GAME.resourceStackModel.subtract(GAME.VALUES['sonde'])) {
        var randomId = Math.floor(Math.random()*1000000); //random numeric ID
        var sonde = new SondeModel({
          id:randomId
        });
        GAME.sondes.add(sonde); //on 'add', trigger sondesview render function
        // -GD- sending warning to the other player everytime we make a move
        // like creating a sonde ?
        send(currentPlayer, 'creating-a-sonde');
      }
      else {
       alert('not enough $$$ !'); 
      }
    });

    //----- fog of war
    $('.g-cell').bind('click', function(e) {
      debug('g-cell clicked id: ' + e.target.id);
      if(GAME.sondes.length > 0) {
        var idOfFirst = GAME.sondes.first().id;
        GAME.sondes.remove(idOfFirst);
        $('#'+e.target.id).removeClass('hidden');
      }
      else {
        alert('Dont have any sonde !');
      }
    });
    //-------- /TESTS

  //---------- Displaying starting dome
  var playerName = $('#player-name').text().trim();
  if (playerName === 'player1') {
    debug('revealing player1 starting dome');
    GAME.gridView.displayStartingDome('player1');
  }
  else if (playerName === 'player2') {
    debug('current player is player2');
    GAME.gridView.displayStartingDome('player2');
  }
  else {
    debug('welcome observer !');
  }

   });

    
 </script>

</head>
<body>

  <header class="row-fluid">
    <div class="span3">
      <h1><a href="/squaredwars">W&#178;</a></h1>
    </div>
    <div id="player-name" class="span3">
      {{player}}
    </div>
    <div id="message-area" class="span5 offset1">
      {{message}}
    </div>
  </header>

  <div class="row-fluid">
    <div id="clock" class="span3"></div>
    <div id="resource-area" class="span6 offset3"></div>
  </div>

  <div class="row-fluid">
    <div id="grid-area" class="span9"></div>
  </div>

  <!-- ITEMS CREATION SECTION -->
  <div class="row-fluid">

    <div id="sondes" class="container span3 offset1">
      <a href="#" id="sonde-creation">+</a>
      <div id="sondes-area">
        <!-- ETAT INITIAL DE LA VUE -->
        <div class="item active">S</div>
        <div class="counter">0</div>
      </div>
    </div>

    <div id="domes" class="container span3 offset1">
      <a href="#" id="dome-creation">+</a>
      <div id="domes-area">
        <!-- ETAT INITIAL DE LA VUE -->
        <div class="item">D</div>
        <div class="counter">0</div>
      </div>

      
    </div>

    <div id="missiles" class="container span3 offset1">
      <a href="#" id="missile-creation">+</a>
      <div id="missiles-area">
        <!-- ETAT INITIAL DE LA VUE -->
        <div class="item">M</div>
        <div class="counter">0</div>
    </div>

  </div>
 
</body>
<!-- TEMPLATES -->
<!-- TODO : could be externalize, see A. Osmani MVC :
http://bit.ly/RdIW2R -->
<script id="template-resource" type="text/html">
  <div><%= stack %>/<%= winningLimit %></div>
</script>

<script id="template-sondes" type="text/html">
  <div class="item active">S</div>
  <div class="counter"><%= numberOfSondes %></div>
</script>
</html>